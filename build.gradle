def group = "docker"
def user = "terahorse"
def image = "jenkins"

task stopContainer(type: Exec, group: group) {
    doFirst { executable "sh"
        args "-c", "docker stop $image || true"
    }
}

task deleteContainer(type: Exec, group: group) {
    doFirst { executable "sh"
        args "-c", "docker rm $image || true"
    }
}

task deleteImage(type: Exec, group: group) {
    doFirst { executable "sh"
        args "-c", "docker rmi $user/$image || true"
    }
}

task createImage(type: Exec, group: group) {
    doFirst { executable "sh"
        args "-c", "docker build -t $user/$image ."
    }
}

task runContainer(type: Exec, group: group) {
    doFirst { executable "sh"
        args "-c", "docker run -p 8080:8080 --privileged=true -d --name $image $user/$image"
    }
}

task publishImage(type: Exec, group: group) {
    doFirst { executable "sh"
        args "-c", "docker push $user/$image"
    }
}

publishImage { dependsOn createImage }
runContainer { dependsOn createImage }
createImage { dependsOn deleteImage }
deleteImage { dependsOn deleteContainer }
deleteContainer { dependsOn stopContainer }
